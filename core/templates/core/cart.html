{% extends "core/base.html" %}
{% load static %}
{% block title %}Cart{% endblock title %}

{% block hero %}
<section class="bg-gradient-to-b from-orange-100 via-orange-50 to-white">
  <div class="container mx-auto px-6 py-14">
    <h1 class="text-3xl lg:text-4xl font-bold text-gray-800">Your Cart</h1>
    <p class="mt-2 text-gray-600">Review your selections before checkout.</p>
  </div>
</section>
{% endblock hero %}

{% block maincontent %}
<section class="container mx-auto px-6 py-16">
  {% if items %}
  <div class="grid gap-8 lg:grid-cols-3">
    <div class="lg:col-span-2 space-y-4">
      {% for it in items %}
      <div
        class="bg-white rounded-2xl shadow-sm hover:shadow border border-orange-100 p-5 flex items-center gap-4 transition"
        data-item
        data-id="{{ it.dish.id }}"
        data-price="{{ it.dish.price }}"
      >
        {% if it.dish.image %}
        <img src="{{ it.dish.image.url }}" alt="{{ it.dish.name }}" class="w-20 h-20 object-cover rounded-xl bg-orange-50" />
        {% else %}
        <img src="{% static 'core/images/paneer.png' %}" alt="{{ it.dish.name }}" class="w-20 h-20 object-cover rounded-xl bg-orange-50" />
        {% endif %}

        <div class="flex-1 min-w-0">
          <h3 class="font-semibold text-gray-800 truncate">{{ it.dish.name }}</h3>
          <p class="text-sm text-gray-500">$<span data-unit-price>{{ it.dish.price }}</span> each</p>

          <div
            class="mt-3 inline-flex items-center gap-2 bg-orange-50 border border-orange-200 rounded-full px-2 py-1"
            data-qty
            data-inc-url="{% url 'cart_increase' it.dish.id %}"
            data-dec-url="{% url 'cart_decrease' it.dish.id %}"
          >
            <button
              type="button"
              class="w-8 h-8 grid place-items-center rounded-full bg-white border border-orange-200 text-gray-700 hover:bg-orange-100 disabled:opacity-50"
              data-action="dec"
              aria-label="Decrease quantity of {{ it.dish.name }}"
            >âˆ’</button>

            <input
              class="w-12 text-center bg-transparent font-semibold text-gray-800 focus:outline-none"
              type="number"
              min="1"
              value="{{ it.qty }}"
              aria-label="Quantity for {{ it.dish.name }}"
              data-qty-input
              readonly
            />

            <button
              type="button"
              class="w-8 h-8 grid place-items-center rounded-full bg-white border border-orange-200 text-gray-700 hover:bg-orange-100"
              data-action="inc"
              aria-label="Increase quantity of {{ it.dish.name }}"
            >+</button>
          </div>
        </div>

        <div class="text-right">
          <div class="font-semibold text-orange-600">
            $<span data-line-total>{{ it.line_total|floatformat:2 }}</span>
          </div>
          <a href="{% url 'cart_remove' it.dish.id %}" class="text-sm text-red-500 hover:underline">Remove</a>
        </div>
      </div>
      {% endfor %}
    </div>

    <aside class="bg-orange-50 rounded-2xl border border-orange-100 p-6 h-fit">
      <h3 class="text-lg font-semibold text-gray-800">Summary</h3>
      <p class="mt-2 text-gray-700">Items: {{ items|length }}</p>
      <p class="mt-1 text-gray-700">
        Total:
        <span class="font-semibold text-orange-600">$<span id="summary-total">{{ total|floatformat:2 }}</span></span>
      </p>
      <a href="{% url 'reservation' %}" class="mt-4 inline-block bg-orange-500 text-white px-6 py-3 rounded-full hover:bg-orange-600">Checkout</a>
    </aside>
  </div>
  {% else %}
  <div class="bg-white rounded-2xl shadow p-8 text-center">
    <p class="text-gray-700">Your cart is empty.</p>
    <a href="{% url 'menu' %}" class="mt-4 inline-block bg-orange-500 text-white px-6 py-3 rounded-full hover:bg-orange-600">Browse Menu</a>
  </div>
  {% endif %}
</section>

<script>
  // CSRF helper (Django)
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  const money = (n) => Number(n).toFixed(2);

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    const card = btn.closest('[data-item]');
    const qtyWrap = btn.closest('[data-qty]');
    const input = card.querySelector('[data-qty-input]');
    const lineTotalEl = card.querySelector('[data-line-total]');
    const action = btn.dataset.action;

    const url = action === 'inc' ? qtyWrap.dataset.incUrl : qtyWrap.dataset.decUrl;
    if (!url) return;

    // Optimistic disable to prevent spam clicks
    btn.disabled = true;

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Accept': 'application/json' },
      });
      if (!res.ok) throw new Error('Request failed');
      const data = await res.json();

      if (typeof data.qty !== 'undefined') input.value = data.qty;
      if (typeof data.line_total !== 'undefined') lineTotalEl.textContent = money(data.line_total);
      if (data.cart && typeof data.cart.total !== 'undefined') {
        const summaryTotal = document.getElementById('summary-total');
        if (summaryTotal) summaryTotal.textContent = money(data.cart.total);
      }
    } catch (err) {
      console.error(err);
    } finally {
      btn.disabled = false;
    }
  });
</script>
{% endblock maincontent %}